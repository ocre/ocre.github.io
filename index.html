<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"><meta property="og:type" content="website"><meta property="og:title" content="憨憨呆呆的IT之旅"><meta property="og:url" content="http://example.com/index.html"><meta property="og:site_name" content="憨憨呆呆的IT之旅"><meta property="og:description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="ocre"><meta property="article:tag" content="憨憨呆呆的IT之旅,技术博客,blog,coding,ocre,个人博客"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>憨憨呆呆的IT之旅</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="憨憨呆呆的IT之旅" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">憨憨呆呆的IT之旅</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">我见，我思，我行</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">ocre</p><div class="site-description" itemprop="description">这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">80</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/ocre" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ocre" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:destra@126.com" title="E-Mail → mailto:destra@126.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2024/02/07/install-redis-6-on-kylin-linux-v10-sword/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/02/07/install-redis-6-on-kylin-linux-v10-sword/" class="post-title-link" itemprop="url">在麒麟V10编译安装redis 6.x</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-02-07 09:38:21 / 修改时间：13:39:55" itemprop="dateCreated datePublished" datetime="2024-02-07T09:38:21+08:00">2024-02-07</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.3k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>现需要在一台信创虚拟机安装redis 6.x, 未找到二进制包版本，因此需要自行编译安装。<br>服务器环境如下：</p><table><thead><tr><th align="center">CPU架构</th><th align="center">系统类别</th><th align="center">系统发行版本</th></tr></thead><tbody><tr><td align="center">x86_64</td><td align="center">Linux</td><td align="center">Kylin Linux Advanced Server release V10 (Sword)</td></tr><tr><td align="center">因为是编译安装，一切都是从源码开始，实际上跟CPU架构和操作系统版本关系不大。下面着重记录一下安装配置过程。</td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="安装redis前的准备工作"><a href="#安装redis前的准备工作" class="headerlink" title="安装redis前的准备工作"></a>安装redis前的准备工作</h2><h3 id="1-预期目标"><a href="#1-预期目标" class="headerlink" title="1. 预期目标"></a>1. 预期目标</h3><table><thead><tr><th align="center">目标项</th><th align="center">目标值</th></tr></thead><tbody><tr><td align="center">安装目录</td><td align="center">&#x2F;usr&#x2F;local&#x2F;redis</td></tr><tr><td align="center">支持TLS</td><td align="center">是</td></tr><tr><td align="center">支持远程访问</td><td align="center">否</td></tr><tr><td align="center">支持免密访问</td><td align="center">否</td></tr><tr><td align="center">集群部署</td><td align="center">暂不考虑</td></tr></tbody></table><h3 id="2-编译环境准备"><a href="#2-编译环境准备" class="headerlink" title="2. 编译环境准备"></a>2. 编译环境准备</h3><p>主要是准备好gcc编译器。<br>一般来说麒麟V10已经自带gcc，我机器上gcc版本是7.3.0，版本已经比<code>CentOS 7.x</code>的<code>4.8.5</code>新了，本着够用就好的原则，没有升级到高版本的必要。</p><h3 id="3-准备依赖包"><a href="#3-准备依赖包" class="headerlink" title="3. 准备依赖包"></a>3. 准备依赖包</h3><p>主要是<code>openssl</code>库。如果redis不使用<code>TLS</code>模式的话，本步骤可以跳过。<br>我机器上已经自带了<code>OpenSSL 1.1.1f</code>版本，只需要额外安装<code>openssl-devel</code>库即可。<br>偷懒选择<code>yum</code>方式安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openssl-devel</span><br></pre></td></tr></table></figure><p>这里简单说明一下，机器是离线的，但事先配置好了本地yum源<a href="/2024/02/07/configure-local-yum-repository-for-kylin-V10/" title="给麒麟V10配置本地离线yum源">本地yum源配置方法看这里</a>，所以可以用<code>yum install</code>来安装一些系统镜像里自带的库。</p><h2 id="编译安装redis"><a href="#编译安装redis" class="headerlink" title="编译安装redis"></a>编译安装redis</h2><h3 id="1-准备官网源码"><a href="#1-准备官网源码" class="headerlink" title="1. 准备官网源码"></a>1. 准备官网源码</h3><p>先从官网（<a target="_blank" rel="noopener" href="http://download.redis.io/releases/%EF%BC%89%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC%E6%BA%90%E7%A0%81%E5%8C%85%E3%80%82">http://download.redis.io/releases/）下载对应版本源码包。</a> 我下载的是<code>6.2.14</code>版本，下面的记录都以这个版本为准。<br>上传压缩包到安装目标机器，使用<code>tar xvfz redis-6.2.14.tar.gz</code>解压。<br>解压后目录为：<code>redis-6.2.14</code></p><h3 id="2-编译安装"><a href="#2-编译安装" class="headerlink" title="2. 编译安装"></a>2. 编译安装</h3><p>依次执行如下命令进行编译：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入源码目录</span></span><br><span class="line">cd redis-6.2.14</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先编译deps子目录下的依赖库</span></span><br><span class="line">cd deps</span><br><span class="line">make -j4 hiredis lua jemalloc linenoise</span><br><span class="line">cd ..</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译（启用TLS支持，这个参数可选）</span></span><br><span class="line">make -j4 BUILD_TLS=yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试一下，这个命令执行时间较长</span></span><br><span class="line">make test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装到自定义目录</span></span><br><span class="line">make install PREFIX=/usr/local/redis</span><br></pre></td></tr></table></figure><p><code>make</code>过程中可能会出现各种问题，这里就要具体问题具体分析了。一般都是因为缺少lib库，或者没有事先编译deps目录下的依赖库造成的，根据错误提示找找缺少的库文件等等，缺啥补啥，然后<code>make distclean</code>后重新make，大概率能解决。</p><h2 id="配置redis服务"><a href="#配置redis服务" class="headerlink" title="配置redis服务"></a>配置redis服务</h2><h3 id="设置配置文件"><a href="#设置配置文件" class="headerlink" title="设置配置文件"></a>设置配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在安装目录下创建子目录：</span></span><br><span class="line">mkdir /usr/local/redis/conf</span><br><span class="line">mkdir /usr/local/redis/data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">从源码目录copy配置文件`redis.conf`到安装目录的`conf`子目录</span></span><br><span class="line">cd redis-6.2.14</span><br><span class="line">cp redis.conf /usr/local/redis/conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据预先规划需要，编辑redis.conf</span></span><br><span class="line">vim redis.conf</span><br></pre></td></tr></table></figure><p>主要修改配置项包括：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 只开启本地监听</span><br><span class="line">bind 127.0.0.1 -::1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line">dir /usr/local/redis/data</span><br><span class="line">requirepass &quot;密码&quot;</span><br></pre></td></tr></table></figure><p>使用<code>cat /usr/local/redis/conf/redis.conf |grep -v &quot;^#&quot;|grep -v &quot;^$&quot;</code>命令得到完整有效的配置项如下（已过滤注释），供参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1 -::1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo no</span><br><span class="line">set-proc-title yes</span><br><span class="line">proc-title-template &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">rdb-del-sync-files no</span><br><span class="line">dir /usr/local/redis/data</span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-diskless-load disabled</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">acllog-max-len 128</span><br><span class="line">requirepass &quot;jgDWw**RxRG&amp;%#J3&quot;</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">lazyfree-lazy-user-del no</span><br><span class="line">lazyfree-lazy-user-flush no</span><br><span class="line">oom-score-adj no</span><br><span class="line">oom-score-adj-values 0 200 800</span><br><span class="line">disable-thp yes</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line">jemalloc-bg-thread yes</span><br></pre></td></tr></table></figure><h3 id="配置开机启动"><a href="#配置开机启动" class="headerlink" title="配置开机启动"></a>配置开机启动</h3><p>新建或编辑一个启动配置文件：<code>vim /lib/systemd/system/redis.service</code><br>文件内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Redis</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/redis_6379.pid</span><br><span class="line">ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/conf/redis.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>然后执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable redis</span><br><span class="line">systemctl start redis</span><br><span class="line">systemctl status redis</span><br></pre></td></tr></table></figure><h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><p>下面列一下我用来验证redis的命令, 供参考：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开命令行客户端</span></span><br><span class="line">cd /usr/local/redis</span><br><span class="line">bin/redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入密码完成认证</span></span><br><span class="line">auth &quot;密码&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选择db 0</span></span><br><span class="line">select 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置键值对 a:10</span></span><br><span class="line">set a 10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取所有key</span></span><br><span class="line">keys *</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取a的值</span></span><br><span class="line">get a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除键值对a</span></span><br><span class="line">del a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取所有key</span></span><br><span class="line">keys *</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出客户端</span></span><br><span class="line">quit</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2024/02/07/configure-local-yum-repository-for-kylin-V10/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/02/07/configure-local-yum-repository-for-kylin-V10/" class="post-title-link" itemprop="url">给麒麟V10配置本地离线yum源</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-02-07 08:29:21 / 修改时间：13:41:19" itemprop="dateCreated datePublished" datetime="2024-02-07T08:29:21+08:00">2024-02-07</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>270</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>我拿到的机器是一台Linux内网机，操作系统是麒麟V10, 由于需要自己在无网环境下安装一些软件，这些软件都或多或少依赖一些系统基础包，因此需要配置本地yum源。记录配置过程如下：</p><h3 id="获取系统ios镜像文件"><a href="#获取系统ios镜像文件" class="headerlink" title="获取系统ios镜像文件"></a>获取系统ios镜像文件</h3><p>这个需要自行获取。</p><h2 id="挂载ios镜像"><a href="#挂载ios镜像" class="headerlink" title="挂载ios镜像"></a>挂载ios镜像</h2><p>我是让同事帮忙挂载的，大体步骤如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 先挂载ios文件</span><br><span class="line">mount /root/upload/Kylin-Server-10-SP2-aarch64-Release-Build09-20210524.iso /run/media/root/Kylin-Server-10</span><br><span class="line"># 再挂载cdrom设备</span><br><span class="line">mount /dev/sr0 /run/media/root/Kylin-Server-10</span><br><span class="line"># 查看挂载点</span><br><span class="line">df -h</span><br><span class="line"># 可以像普通目录一样查看ios文件内容</span><br><span class="line">ls /run/media/root/Kylin-Server-10</span><br></pre></td></tr></table></figure><h2 id="备份yum源"><a href="#备份yum源" class="headerlink" title="备份yum源"></a>备份yum源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/yum.repo.d/</span><br><span class="line">mkdir backup</span><br><span class="line">mv *.repo backup</span><br></pre></td></tr></table></figure><h2 id="配置本地源"><a href="#配置本地源" class="headerlink" title="配置本地源"></a>配置本地源</h2><p>创建<code>xxx.repo</code>文件并设置内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/local.repo &lt;&lt; EOF </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##Kylin Linux Advanced Server 10 - os repo###</span></span></span><br><span class="line"></span><br><span class="line">[ks10-adv-os]</span><br><span class="line">name = Kylin Linux Advanced Server 10 - Os</span><br><span class="line">baseurl = file:///run/media/root/Kylin-Server-10</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-kylin</span><br><span class="line">enabled = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>更新yum源：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum list</span><br></pre></td></tr></table></figure><p>完毕！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2024/01/29/maven-common-commands/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/01/29/maven-common-commands/" class="post-title-link" itemprop="url">maven常用命令整理</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-29 12:52:09 / 修改时间：13:25:22" itemprop="dateCreated datePublished" datetime="2024-01-29T12:52:09+08:00">2024-01-29</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>261</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>记录一下maven常用命令，免得需要时到处乱找。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mvn -v //查看版本</span><br><span class="line">mvn archetype:create //创建 Maven 项目</span><br><span class="line">mvn compile //编译源代码</span><br><span class="line">mvn test-compile //编译测试代码</span><br><span class="line">mvn test //运行应用程序中的单元测试</span><br><span class="line">mvn site //生成项目相关信息的网站</span><br><span class="line">mvn package //依据项目生成 jar 文件</span><br><span class="line">mvn install //在本地 Repository 中安装 jar</span><br><span class="line">mvn -Dmaven.test.skip=true //忽略测试文档编译</span><br><span class="line">mvn clean //清除目标目录中的生成结果</span><br><span class="line">mvn clean compile //将.java类编译为.class文件</span><br><span class="line">mvn clean package //进行打包</span><br><span class="line">mvn clean test //执行单元测试</span><br><span class="line">mvn clean deploy //部署到版本仓库</span><br><span class="line">mvn clean install //使其他项目使用这个jar,会安装到maven本地仓库中</span><br><span class="line">mvn archetype:generate //创建项目架构</span><br><span class="line">mvn dependency:list //查看已解析依赖</span><br><span class="line">mvn dependency:tree //看到依赖树</span><br><span class="line">mvn dependency:analyze //查看依赖的工具</span><br><span class="line">mvn help:system //从中央仓库下载文件至本地仓库</span><br><span class="line">mvn help:active-profiles //查看当前激活的profiles</span><br><span class="line">mvn help:all-profiles //查看所有profiles</span><br><span class="line">mvn help:effective -pom //查看完整的pom信息</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/12/14/how-to-find-linux-release-version/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/12/14/how-to-find-linux-release-version/" class="post-title-link" itemprop="url">如何查看Linux系统版本</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-12-14 10:54:32 / 修改时间：11:03:23" itemprop="dateCreated datePublished" datetime="2023-12-14T10:54:32+08:00">2023-12-14</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>168</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近老是碰到需要确认linux发行版本的需求，自己记不住，每次都去查bing，查烦了。特意搜集整理、记录一下。<br>总的来说，以下这么几种方法搭配使用，效果更佳。</p><ul><li><code>cat /etc/*-release</code> – 感觉这个最靠谱，红帽的、ubuntu的甚至国产的发行版，一般能查出来。</li><li><code>cat /etc/issue</code> – 有时候啥有用信息也没有，查了个寂寞。</li><li><code>lsb_release</code> – 不少发行版不支持，聊胜于无吧。</li><li><code>uname -a</code> – 能看到一些信息吧，比如是 x86_64 架构的，甚至发行版名称也有。</li><li><code>cat /proc/version</code> – 感觉跟uname差不多。</li><li><code>dmesg | grep &quot;Linux&quot;</code> – 难记，不常用</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/12/04/how-to-replace-nan-in-dataframe/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/12/04/how-to-replace-nan-in-dataframe/" class="post-title-link" itemprop="url">pandas DataFrame替换指定列的nan</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-12-04 09:15:32 / 修改时间：10:02:50" itemprop="dateCreated datePublished" datetime="2023-12-04T09:15:32+08:00">2023-12-04</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>175</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>平时习惯针对整个DataFrame把nan替换成0，用<code>df.fillna(0, inplace=True)</code>就OK了。今天突然有人问，如何只替换某一列的<code>nan</code>。测试并记录如下。<br>构建测试DataFrame，由3列组成 <code>name</code>、<code>age</code>、<code>score</code>, 后两列都有<code>nan</code>值。接下来测试如何只处理<code>age</code>列。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;name&#x27;</span>:[<span class="string">&#x27;aby&#x27;</span>,<span class="string">&#x27;boy&#x27;</span>,<span class="string">&#x27;cilia&#x27;</span>],<span class="string">&#x27;age&#x27;</span>:[<span class="number">18</span>,np.nan,<span class="number">20</span>],<span class="string">&#x27;score&#x27;</span>:[<span class="number">9.5</span>,<span class="number">8.0</span>,np.nan]&#125;)</span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line">df[<span class="string">&#x27;age&#x27;</span>].fillna(<span class="number">0</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(df)</span><br></pre></td></tr></table></figure><p>处理前，DataFrame如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    name   age  score</span><br><span class="line">0    aby  18.0    9.5</span><br><span class="line">1    boy   NaN    8.0</span><br><span class="line">2  cilia  20.0    NaN</span><br></pre></td></tr></table></figure><p>处理后，DataFrame如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    name   age  score</span><br><span class="line">0    aby  18.0    9.5</span><br><span class="line">1    boy   0.0    8.0</span><br><span class="line">2  cilia  20.0    NaN</span><br></pre></td></tr></table></figure><p>以上示例代码表明，可直接用<code>fillna()</code>方法针对某一列<code>DataSeries</code>做替换，参数同<code>DataFrame</code>一样。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/11/30/usecases-of-postgresql-window-functions/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/11/30/usecases-of-postgresql-window-functions/" class="post-title-link" itemprop="url">常用的PostgreSQL窗口函数的案例学习</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-30 09:21:29" itemprop="dateCreated datePublished" datetime="2023-11-30T09:21:29+08:00">2023-11-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-02 18:24:08" itemprop="dateModified" datetime="2023-12-02T18:24:08+08:00">2023-12-02</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.1k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="窗口函数简介"><a href="#窗口函数简介" class="headerlink" title="窗口函数简介"></a>窗口函数简介</h3><p>窗口函数主要是用来对表的数值字段做统计分析的。既然是统计分析就必然涉及到多条记录。<br>窗口函数一般配合<code>avg</code>、<code>max</code>等聚合函数一起使用，通过跨越多行记录的统计数据来影响当前行。<br>它们跟普通聚合函数最大的不同在于它们不改变结果集记录行数。<br>窗口函数的调用语法类似：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function_name(expression) over(window_name)</span><br></pre></td></tr></table></figure><p><code>function_name</code>可以为<code>max</code>,<code>min</code>,<code>avg</code>,<code>sum</code>,<code>count</code>等普通聚合函数，也可以为<code>rank</code>,<code>dense_rank</code>等排名函数。<br><code>over</code>子句确定了窗口划分方法，也就是我们通常意义上说的<code>分组</code>,类似<code>group by</code>。</p><h3 id="窗口函数注意事项"><a href="#窗口函数注意事项" class="headerlink" title="窗口函数注意事项"></a>窗口函数注意事项</h3><h4 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h4><p>窗口函数在<code>GROUP BY</code>、<code>HAVING</code>、<code>WHERE</code>子句以及聚合函数之后、排序子句之前执行。因此只允许出现在查询的<code>SELECT</code>和<code>ORDER BY</code>子句中。</p><h3 id="窗口函数案例学习"><a href="#窗口函数案例学习" class="headerlink" title="窗口函数案例学习"></a>窗口函数案例学习</h3><p>下面用一些实际的使用场景来说明窗口函数的作用。</p><h4 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h4><p>先准备一些测试数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- postgresql创建自增序列和表结构</span></span><br><span class="line"><span class="keyword">CREATE</span> SEQUENCE employee_empno_seq <span class="keyword">START</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employee_tbl (</span><br><span class="line">  empno int4 <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> nextval(<span class="string">&#x27;employee_empno_seq&#x27;</span>::regclass),</span><br><span class="line">  empname <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> &quot;pg_catalog&quot;.&quot;default&quot;,</span><br><span class="line">  deptname <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> &quot;pg_catalog&quot;.&quot;default&quot;,</span><br><span class="line">  salary int4,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (&quot;empno&quot;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employee_tbl(empno,deptname,empname,salary) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>,<span class="string">&#x27;sales&#x27;</span>,<span class="string">&#x27;s1&#x27;</span>,<span class="number">5000</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="string">&#x27;personnel&#x27;</span>,<span class="string">&#x27;p1&#x27;</span>,<span class="number">3900</span>),</span><br><span class="line">(<span class="number">3</span>,<span class="string">&#x27;sales&#x27;</span>,<span class="string">&#x27;s2&#x27;</span>,<span class="number">4800</span>),</span><br><span class="line">(<span class="number">4</span>,<span class="string">&#x27;sales&#x27;</span>,<span class="string">&#x27;s3&#x27;</span>,<span class="number">5000</span>),</span><br><span class="line">(<span class="number">5</span>,<span class="string">&#x27;personnel&#x27;</span>,<span class="string">&#x27;p2&#x27;</span>,<span class="number">3500</span>),</span><br><span class="line">(<span class="number">6</span>,<span class="string">&#x27;personnel&#x27;</span>,<span class="string">&#x27;p3&#x27;</span>,<span class="number">4100</span>),</span><br><span class="line">(<span class="number">7</span>,<span class="string">&#x27;develop&#x27;</span>,<span class="string">&#x27;d1&#x27;</span>,<span class="number">4200</span>),</span><br><span class="line">(<span class="number">8</span>,<span class="string">&#x27;develop&#x27;</span>,<span class="string">&#x27;d2&#x27;</span>,<span class="number">6000</span>),</span><br><span class="line">(<span class="number">9</span>,<span class="string">&#x27;develop&#x27;</span>,<span class="string">&#x27;d3&#x27;</span>,<span class="number">4500</span>),</span><br><span class="line">(<span class="number">10</span>,<span class="string">&#x27;develop&#x27;</span>,<span class="string">&#x27;d4&#x27;</span>,<span class="number">5200</span>),</span><br><span class="line">(<span class="number">11</span>,<span class="string">&#x27;develop&#x27;</span>,<span class="string">&#x27;d5&#x27;</span>,<span class="number">5200</span>);</span><br></pre></td></tr></table></figure><p>准备好的表数据如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary</span><br><span class="line">-------+---------+-----------+--------</span><br><span class="line">     1 | s1      | sales     |   5000</span><br><span class="line">     2 | p1      | personnel |   3900</span><br><span class="line">     3 | s2      | sales     |   4800</span><br><span class="line">     4 | s3      | sales     |   5000</span><br><span class="line">     5 | p2      | personnel |   3500</span><br><span class="line">     6 | p3      | personnel |   4100</span><br><span class="line">     7 | d1      | develop   |   4200</span><br><span class="line">     8 | d2      | develop   |   6000</span><br><span class="line">     9 | d3      | develop   |   4500</span><br><span class="line">    10 | d4      | develop   |   5200</span><br><span class="line">    11 | d5      | develop   |   5200</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><h4 id="统计员工工资和所在部门平均工资的差异百分比"><a href="#统计员工工资和所在部门平均工资的差异百分比" class="headerlink" title="统计员工工资和所在部门平均工资的差异百分比"></a>统计员工工资和所在部门平均工资的差异百分比</h4><p>使用窗口函数计算各部门平均工资：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> empno,empname,deptname,salary,(<span class="built_in">avg</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname)) <span class="keyword">as</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employee_tbl</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary |      avg_salary</span><br><span class="line">-------+---------+-----------+--------+-----------------------</span><br><span class="line">     1 | s1      | sales     |   5000 | 4933.3333333333333333</span><br><span class="line">     2 | p1      | personnel |   3900 | 3833.3333333333333333</span><br><span class="line">     3 | s2      | sales     |   4800 | 4933.3333333333333333</span><br><span class="line">     4 | s3      | sales     |   5000 | 4933.3333333333333333</span><br><span class="line">     5 | p2      | personnel |   3500 | 3833.3333333333333333</span><br><span class="line">     6 | p3      | personnel |   4100 | 3833.3333333333333333</span><br><span class="line">     7 | d1      | develop   |   4200 | 5020.0000000000000000</span><br><span class="line">     8 | d2      | develop   |   6000 | 5020.0000000000000000</span><br><span class="line">     9 | d3      | develop   |   4500 | 5020.0000000000000000</span><br><span class="line">    10 | d4      | develop   |   5200 | 5020.0000000000000000</span><br><span class="line">    11 | d5      | develop   |   5200 | 5020.0000000000000000</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>对上述sql美化一下,把平均工资取整，再加上员工工资跟部门平均工资的差异比例（这里暂不考虑性能调优啥的）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> empno,empname,deptname,salary,(round(<span class="built_in">avg</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname))) <span class="keyword">as</span> avg_salary, round(((salary<span class="operator">/</span>(<span class="built_in">avg</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname)))<span class="number">-1</span>), <span class="number">2</span>) <span class="keyword">as</span> diff_ratio </span><br><span class="line"><span class="keyword">FROM</span> employee_tbl</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>最终得到结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | avg_salary | diff_ratio</span><br><span class="line">-------+---------+-----------+--------+------------+------------</span><br><span class="line">     1 | s1      | sales     |   5000 |       4933 |       0.01</span><br><span class="line">     2 | p1      | personnel |   3900 |       3833 |       0.02</span><br><span class="line">     3 | s2      | sales     |   4800 |       4933 |      -0.03</span><br><span class="line">     4 | s3      | sales     |   5000 |       4933 |       0.01</span><br><span class="line">     5 | p2      | personnel |   3500 |       3833 |      -0.09</span><br><span class="line">     6 | p3      | personnel |   4100 |       3833 |       0.07</span><br><span class="line">     7 | d1      | develop   |   4200 |       5020 |      -0.16</span><br><span class="line">     8 | d2      | develop   |   6000 |       5020 |       0.20</span><br><span class="line">     9 | d3      | develop   |   4500 |       5020 |      -0.10</span><br><span class="line">    10 | d4      | develop   |   5200 |       5020 |       0.04</span><br><span class="line">    11 | d5      | develop   |   5200 |       5020 |       0.04</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>这样我们就能很直观的看到部门内每个员工工资相对平均工资的偏离情况了。<br>如果窗口函数的<code>over</code>子句括号内容为空，则表示把所有结果集作为一个分组来处理。例如，以下SQL可以在员工工资记录后追加一列“公司平均工资”：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> empno,empname,deptname,salary,round(<span class="built_in">avg</span>(salary) <span class="keyword">over</span>()) <span class="keyword">as</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employee_tbl</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>得到结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | avg_salary</span><br><span class="line">-------+---------+-----------+--------+------------</span><br><span class="line">     1 | s1      | sales     |   5000 |       4673</span><br><span class="line">     2 | p1      | personnel |   3900 |       4673</span><br><span class="line">     3 | s2      | sales     |   4800 |       4673</span><br><span class="line">     4 | s3      | sales     |   5000 |       4673</span><br><span class="line">     5 | p2      | personnel |   3500 |       4673</span><br><span class="line">     6 | p3      | personnel |   4100 |       4673</span><br><span class="line">     7 | d1      | develop   |   4200 |       4673</span><br><span class="line">     8 | d2      | develop   |   6000 |       4673</span><br><span class="line">     9 | d3      | develop   |   4500 |       4673</span><br><span class="line">    10 | d4      | develop   |   5200 |       4673</span><br><span class="line">    11 | d5      | develop   |   5200 |       4673</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><h4 id="按员工工资由高到低排名"><a href="#按员工工资由高到低排名" class="headerlink" title="按员工工资由高到低排名"></a>按员工工资由高到低排名</h4><p>先在全公司排名：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno, empname, deptname, salary, <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">from</span> employee_tbl;</span><br></pre></td></tr></table></figure><p>得到结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | rank</span><br><span class="line">-------+---------+-----------+--------+------</span><br><span class="line">     8 | d2      | develop   |   6000 |    1</span><br><span class="line">    11 | d5      | develop   |   5200 |    2</span><br><span class="line">    10 | d4      | develop   |   5200 |    2</span><br><span class="line">     1 | s1      | sales     |   5000 |    4</span><br><span class="line">     4 | s3      | sales     |   5000 |    4</span><br><span class="line">     3 | s2      | sales     |   4800 |    6</span><br><span class="line">     9 | d3      | develop   |   4500 |    7</span><br><span class="line">     7 | d1      | develop   |   4200 |    8</span><br><span class="line">     6 | p3      | personnel |   4100 |    9</span><br><span class="line">     2 | p1      | personnel |   3900 |   10</span><br><span class="line">     5 | p2      | personnel |   3500 |   11</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>接着在各自部门内排名：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno, empname, deptname, salary, <span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">from</span> employee_tbl;</span><br></pre></td></tr></table></figure><p>得到结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | rank</span><br><span class="line">-------+---------+-----------+--------+------</span><br><span class="line">     8 | d2      | develop   |   6000 |    1</span><br><span class="line">    11 | d5      | develop   |   5200 |    2</span><br><span class="line">    10 | d4      | develop   |   5200 |    2</span><br><span class="line">     9 | d3      | develop   |   4500 |    4</span><br><span class="line">     7 | d1      | develop   |   4200 |    5</span><br><span class="line">     6 | p3      | personnel |   4100 |    1</span><br><span class="line">     2 | p1      | personnel |   3900 |    2</span><br><span class="line">     5 | p2      | personnel |   3500 |    3</span><br><span class="line">     1 | s1      | sales     |   5000 |    1</span><br><span class="line">     4 | s3      | sales     |   5000 |    1</span><br><span class="line">     3 | s2      | sales     |   4800 |    3</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>观察上述两个案例中的<code>rank()</code>得到的排名，如果有并列第N名，则排名序号会不连续。比如上面示例，并列第2名后直接跳到了第4名，没有第3名。如果想要名次编号连续，可以换成<code>dense_rank()</code>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,empname,deptname,salary,<span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>) <span class="keyword">from</span> employee_tbl;</span><br></pre></td></tr></table></figure><p>得到结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | dense_rank</span><br><span class="line">-------+---------+-----------+--------+------------</span><br><span class="line">     8 | d2      | develop   |   6000 |          1</span><br><span class="line">    11 | d5      | develop   |   5200 |          2</span><br><span class="line">    10 | d4      | develop   |   5200 |          2</span><br><span class="line">     1 | s1      | sales     |   5000 |          3</span><br><span class="line">     4 | s3      | sales     |   5000 |          3</span><br><span class="line">     3 | s2      | sales     |   4800 |          4</span><br><span class="line">     9 | d3      | develop   |   4500 |          5</span><br><span class="line">     7 | d1      | develop   |   4200 |          6</span><br><span class="line">     6 | p3      | personnel |   4100 |          7</span><br><span class="line">     2 | p1      | personnel |   3900 |          8</span><br><span class="line">     5 | p2      | personnel |   3500 |          9</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>可见，使用<code>dense_rank()</code>后，并列第2名之后就是并列第3名。</p><h4 id="在员工工资记录后展示各部门工资总额列"><a href="#在员工工资记录后展示各部门工资总额列" class="headerlink" title="在员工工资记录后展示各部门工资总额列"></a>在员工工资记录后展示各部门工资总额列</h4><p>直接使用<code>sum()</code>聚合函数对应的窗口函数：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,empname,deptname,salary,(<span class="built_in">sum</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname)) <span class="keyword">as</span> dept_total_salary <span class="keyword">from</span> employee_tbl <span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | dept_total_salary</span><br><span class="line">-------+---------+-----------+--------+-------------------</span><br><span class="line">     1 | s1      | sales     |   5000 |             14800</span><br><span class="line">     2 | p1      | personnel |   3900 |             11500</span><br><span class="line">     3 | s2      | sales     |   4800 |             14800</span><br><span class="line">     4 | s3      | sales     |   5000 |             14800</span><br><span class="line">     5 | p2      | personnel |   3500 |             11500</span><br><span class="line">     6 | p3      | personnel |   4100 |             11500</span><br><span class="line">     7 | d1      | develop   |   4200 |             25100</span><br><span class="line">     8 | d2      | develop   |   6000 |             25100</span><br><span class="line">     9 | d3      | develop   |   4500 |             25100</span><br><span class="line">    10 | d4      | develop   |   5200 |             25100</span><br><span class="line">    11 | d5      | develop   |   5200 |             25100</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><h4 id="在员工工资记录后展示各部门截止当前员工记录行累加得到的工资总额列"><a href="#在员工工资记录后展示各部门截止当前员工记录行累加得到的工资总额列" class="headerlink" title="在员工工资记录后展示各部门截止当前员工记录行累加得到的工资总额列"></a>在员工工资记录后展示各部门截止当前员工记录行累加得到的工资总额列</h4><p>直接使用<code>sum()</code>聚合函数对应的窗口函数, 注意<code>over</code>子句要使用<code>order by</code>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,empname,deptname,salary,(<span class="built_in">sum</span>(salary) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptname <span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>)) <span class="keyword">as</span> dept_total_salary <span class="keyword">from</span> employee_tbl <span class="keyword">order</span> <span class="keyword">by</span> deptname <span class="keyword">asc</span>, empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | dept_total_salary</span><br><span class="line">-------+---------+-----------+--------+-------------------</span><br><span class="line">     7 | d1      | develop   |   4200 |              4200</span><br><span class="line">     8 | d2      | develop   |   6000 |             10200</span><br><span class="line">     9 | d3      | develop   |   4500 |             14700</span><br><span class="line">    10 | d4      | develop   |   5200 |             19900</span><br><span class="line">    11 | d5      | develop   |   5200 |             25100</span><br><span class="line">     2 | p1      | personnel |   3900 |              3900</span><br><span class="line">     5 | p2      | personnel |   3500 |              7400</span><br><span class="line">     6 | p3      | personnel |   4100 |             11500</span><br><span class="line">     1 | s1      | sales     |   5000 |              5000</span><br><span class="line">     3 | s2      | sales     |   4800 |              9800</span><br><span class="line">     4 | s3      | sales     |   5000 |             14800</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>这里需要特别注意一下，dept_total_salary是首先按部门分组，再对部门内员工记录按<code>empno</code>升序排序，然后累加计算组内(本例中即部门内)第一条记录到当前记录的工资得到的。</p><h4 id="获取工资前3高的员工"><a href="#获取工资前3高的员工" class="headerlink" title="获取工资前3高的员工"></a>获取工资前3高的员工</h4><p>需要先用窗口函数对员工按工资排序，然后排序号&lt;4的几条记录。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> empno,empname,deptname,salary,(<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>)) <span class="keyword">as</span> pos <span class="keyword">from</span> employee_tbl</span><br><span class="line">) <span class="keyword">as</span> a <span class="keyword">where</span> a.pos <span class="operator">&lt;</span> <span class="number">4</span>;</span><br></pre></td></tr></table></figure><p>也可以根据需要取前3条记录:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span> empno,empname,deptname,salary,(<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>)) <span class="keyword">as</span> pos <span class="keyword">from</span> employee_tbl</span><br><span class="line">) <span class="keyword">as</span> a limit <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>或：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,empname,deptname,salary,(<span class="built_in">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>)) <span class="keyword">as</span> pos <span class="keyword">from</span> employee_tbl limit <span class="number">3</span>;</span><br></pre></td></tr></table></figure><h4 id="在员工工资记录后展示所在部门截止当前员工记录的工资总额和平均工资"><a href="#在员工工资记录后展示所在部门截止当前员工记录的工资总额和平均工资" class="headerlink" title="在员工工资记录后展示所在部门截止当前员工记录的工资总额和平均工资"></a>在员工工资记录后展示所在部门截止当前员工记录的工资总额和平均工资</h4><p>这里需要两个窗口函数，可以复用<code>partition by xxx order by yyy</code>部分：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> empno,empname,deptname,(<span class="built_in">sum</span>(salary) <span class="keyword">over</span> w) <span class="keyword">as</span> dept_total_salary, round(<span class="built_in">avg</span>(salary) <span class="keyword">over</span> w) <span class="keyword">as</span> avg_salary <span class="keyword">FROM</span> employee_tbl <span class="keyword">WINDOW</span> w <span class="keyword">as</span></span><br><span class="line">(<span class="keyword">partition</span> <span class="keyword">by</span> deptname <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">asc</span>);</span><br></pre></td></tr></table></figure><p>结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | dept_total_salary | avg_salary</span><br><span class="line">-------+---------+-----------+-------------------+------------</span><br><span class="line">     7 | d1      | develop   |              4200 |       4200</span><br><span class="line">     9 | d3      | develop   |              8700 |       4350</span><br><span class="line">    10 | d4      | develop   |             19100 |       4775</span><br><span class="line">    11 | d5      | develop   |             19100 |       4775</span><br><span class="line">     8 | d2      | develop   |             25100 |       5020</span><br><span class="line">     5 | p2      | personnel |              3500 |       3500</span><br><span class="line">     2 | p1      | personnel |              7400 |       3700</span><br><span class="line">     6 | p3      | personnel |             11500 |       3833</span><br><span class="line">     3 | s2      | sales     |              4800 |       4800</span><br><span class="line">     1 | s1      | sales     |             14800 |       4933</span><br><span class="line">     4 | s3      | sales     |             14800 |       4933</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure><p>吐槽一下，感觉这个需求好没意义，纯粹为了炫技。<br>同样的，开头计算部门平均工资以及员工工资和部门平均工资偏差比例的sql也可以稍微简化一下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> empno,empname,deptname,salary,round(<span class="built_in">avg</span>(salary) <span class="keyword">over</span> w) <span class="keyword">as</span> avg_salary, round(salary<span class="operator">/</span>(<span class="built_in">avg</span>(salary) <span class="keyword">over</span> w)<span class="number">-1</span>, <span class="number">2</span>) <span class="keyword">as</span> diff_ratio </span><br><span class="line"><span class="keyword">FROM</span> employee_tbl</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">as</span> (<span class="keyword">partition</span> <span class="keyword">by</span> deptname)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> empno <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure><p>执行结果跟原始语句相同：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> empno | empname | deptname  | salary | avg_salary | diff_ratio</span><br><span class="line">-------+---------+-----------+--------+------------+------------</span><br><span class="line">     1 | s1      | sales     |   5000 |       4933 |       0.01</span><br><span class="line">     2 | p1      | personnel |   3900 |       3833 |       0.02</span><br><span class="line">     3 | s2      | sales     |   4800 |       4933 |      -0.03</span><br><span class="line">     4 | s3      | sales     |   5000 |       4933 |       0.01</span><br><span class="line">     5 | p2      | personnel |   3500 |       3833 |      -0.09</span><br><span class="line">     6 | p3      | personnel |   4100 |       3833 |       0.07</span><br><span class="line">     7 | d1      | develop   |   4200 |       5020 |      -0.16</span><br><span class="line">     8 | d2      | develop   |   6000 |       5020 |       0.20</span><br><span class="line">     9 | d3      | develop   |   4500 |       5020 |      -0.10</span><br><span class="line">    10 | d4      | develop   |   5200 |       5020 |       0.04</span><br><span class="line">    11 | d5      | develop   |   5200 |       5020 |       0.04</span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/11/29/most-useful-postgresql-commands/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/11/29/most-useful-postgresql-commands/" class="post-title-link" itemprop="url">个人最常用的PostgreSQL命令整理</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-29 10:10:29" itemprop="dateCreated datePublished" datetime="2023-11-29T10:10:29+08:00">2023-11-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-02 18:23:42" itemprop="dateModified" datetime="2023-12-02T18:23:42+08:00">2023-12-02</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>604</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="psql命令"><a href="#psql命令" class="headerlink" title="psql命令"></a>psql命令</h3><p>列出所有数据库:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -l</span><br></pre></td></tr></table></figure><p>进入指定数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -d my_db_name</span><br></pre></td></tr></table></figure><p>带用户名密码进入指定数据库:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -h your_host_name_or_ip -p your_port -U username -W</span><br></pre></td></tr></table></figure><p>执行sql文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -d my_db_name -f a.sql</span><br></pre></td></tr></table></figure><p>通过一条终端指令执行简单操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -d my_db_name -c &quot;\dt&quot;</span><br></pre></td></tr></table></figure><p>上述指令可替代如下三条指令构成的操作序列：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psql -d my_db_name</span><br><span class="line">\dt</span><br><span class="line">\q</span><br></pre></td></tr></table></figure><p>单步执行SQL指令，每一步都要敲回车确认:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -s</span><br></pre></td></tr></table></figure><p>查看版本号：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -V</span><br></pre></td></tr></table></figure><h3 id="数据库信息查看"><a href="#数据库信息查看" class="headerlink" title="数据库信息查看"></a>数据库信息查看</h3><p>查看有哪些用户:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\du</span><br></pre></td></tr></table></figure><p>切换数据库:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\c my_db_name</span><br></pre></td></tr></table></figure><p>查看有哪些数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\l</span><br></pre></td></tr></table></figure><p>查看当前数据库下有哪些表:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\dt</span><br></pre></td></tr></table></figure><p>查看某个表的信息:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d my_table_name</span><br></pre></td></tr></table></figure><p>查看有哪些索引:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\di</span><br></pre></td></tr></table></figure><p>查看有哪些表空间：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\db</span><br></pre></td></tr></table></figure><p>退出psql：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure><p>执行外部SQL文件:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\i a.sql</span><br></pre></td></tr></table></figure><p>把后续执行结果写入外部文件,直到退出psql:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\o output_file.txt</span><br></pre></td></tr></table></figure><p>查看可用指令列表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\?</span><br></pre></td></tr></table></figure><p>查看某个命令的语法帮助:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\h create table</span><br></pre></td></tr></table></figure><h3 id="数据库使用状态查看"><a href="#数据库使用状态查看" class="headerlink" title="数据库使用状态查看"></a>数据库使用状态查看</h3><p>查看数据库占用空间大小:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select pg_database_size(&#x27;my_test_db&#x27;);</span><br></pre></td></tr></table></figure><p>查看所有数据库占用空间的大小:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select datname, pg_database_size(datname) AS size from pg_database;</span><br></pre></td></tr></table></figure><p>查看所有数据库占用空间大小，并以KB、MB等可读方式显示:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select datname, pg_size_pretty(pg_database_size(datname)) as size from pg_database;</span><br></pre></td></tr></table></figure><p>查看表或索引大小:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select pg_relation_size(&#x27;my_table_or_index_name&#x27;);</span><br></pre></td></tr></table></figure><p>查看表的总大小，包括索引:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select pg_size_pretty(pg_total_relation_size(my_table));</span><br></pre></td></tr></table></figure><p>查看表空间大小:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select pg_size_pretty(pg_tablespace_size(&#x27;pg_default&#x27;));</span><br></pre></td></tr></table></figure><h3 id="数据库、用户设置"><a href="#数据库、用户设置" class="headerlink" title="数据库、用户设置"></a>数据库、用户设置</h3><p>创建用户:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user my_test_user with password &#x27;my_password&#x27;;</span><br></pre></td></tr></table></figure><p>创建数据库:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database my_test_db;</span><br></pre></td></tr></table></figure><p>把数据库分配给用户:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter database my_test_db owner my_test_user;</span><br></pre></td></tr></table></figure><p>直接创建用户并设置属主：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database my_test_db_2 owner my_test_user;</span><br></pre></td></tr></table></figure><p>别忘了把权限赋予用户:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant all privileges on database my_test_db to my_test_user;</span><br></pre></td></tr></table></figure><p>如果用新创建的数据库用户登录报以下错误：<br><code>psql: error: connection to server on socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot; failed: FATAL: Peer authentication failed for user &quot;my_test_user&quot;</code><br>这是因为，该机器上psql的连接建立于Unix Socket上默认使用peer authentication，必须要用和数据库用户相同的系统用户进行登录。<br>解决办法也简单，要么创建对应的操作系统用户<code>my_test_user</code>后<code>sudo su - my_test_user</code>再用<code>psql -d my_test_db</code>登录，要么把登录认证方式从<code>peer authentiction</code>改为<code>md5</code>。</p><p>如果要收回权限，使用下面语句:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">revoke all on database my_test_db from my_test_user;</span><br></pre></td></tr></table></figure><p>删除数据库用户，使用下面语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop user my_test_user;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/11/20/how-to-copy-file-content-to-clipboard/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/11/20/how-to-copy-file-content-to-clipboard/" class="post-title-link" itemprop="url">如何用系统命令把文件内容复制到剪贴板</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-20 12:15:32 / 修改时间：11:11:55" itemprop="dateCreated datePublished" datetime="2023-11-20T12:15:32+08:00">2023-11-20</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>310</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>换电脑后需要给<code>github</code>配置新的<code>ssh key</code>以便于通过<code>ssh</code>协议免密<code>push</code>代码。使用<code>ssh-keygen -t rsa -C &quot;xx@xx.com&quot;</code> 在本机生成<code>ssh密钥对</code>后，需要把<code>~/.id_rsa.pub</code>公钥文件的内容复制出来，再粘贴到<code>github</code>账号里。通常做法是用诸如记事本、notpad++等文本编辑软件直接打开<code>id_rsa.pub</code>文件，然后<code>Ctrl+A</code>、<code>Ctrl+C</code>复制到系统剪贴板即可。不过为了显得有技术范(装逼)，想试试直接用命令行执行这一动作。一时记不起来windows下如何用命令行复制文件内容了，查了些资料，整理如下。</p><h4 id="Windows-PowerShell"><a href="#Windows-PowerShell" class="headerlink" title="Windows PowerShell"></a>Windows PowerShell</h4><p>对于<code>PowerShell</code>, 直接使用如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat id_rsa.pub | clip</span><br></pre></td></tr></table></figure><h4 id="Windows-CommandLine"><a href="#Windows-CommandLine" class="headerlink" title="Windows CommandLine"></a>Windows CommandLine</h4><p>对于传统的<code>cmd</code>命令行，直接使用如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clip &lt; id_rsa.pub</span><br></pre></td></tr></table></figure><h3 id="Linux-Shell"><a href="#Linux-Shell" class="headerlink" title="Linux Shell"></a>Linux Shell</h3><p>对于<code>Linux</code>系统来说，反倒比较麻烦一点点，需要先安装外部小工具，<code>xsel</code>、<code>xclip</code>, 使用<code>yum</code>或<code>apt-get</code>安装都可以。<br>如果是<code>xclip</code>，直接用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat id_rsa.pub | xclip</span><br></pre></td></tr></table></figure><p>如果是<code>xsel</code>, 使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat id_rsa.pub | xsel</span><br></pre></td></tr></table></figure><p>内容将复制到系统剪贴板。注意，一般云厂商提供的服务器没有配置输入输出设备，这俩命令都无效。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/11/20/how-to-merge-two-dataframe-columns-with-pandas/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/11/20/how-to-merge-two-dataframe-columns-with-pandas/" class="post-title-link" itemprop="url">pandas中如何合并DataFrame的两列</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-20 12:15:32" itemprop="dateCreated datePublished" datetime="2023-11-20T12:15:32+08:00">2023-11-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-01 10:35:17" itemprop="dateModified" datetime="2023-12-01T10:35:17+08:00">2023-12-01</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>341</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>如下DataFrame, 一列日期，一列时间，现需要把日期和时间合并为一列。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame([[<span class="string">&#x27;2023-01-05&#x27;</span>,<span class="string">&#x27;0930&#x27;</span>,<span class="number">100</span>],[<span class="string">&#x27;2023-01-05&#x27;</span>,<span class="string">&#x27;0935&#x27;</span>,<span class="number">200</span>],[<span class="string">&#x27;2023-01-05&#x27;</span>,<span class="string">&#x27;0940&#x27;</span>,<span class="number">333</span>]],columns=[<span class="string">&#x27;日期&#x27;</span>,<span class="string">&#x27;时间&#x27;</span>,<span class="string">&#x27;数量&#x27;</span>])</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">       日期    时间   数量</span><br><span class="line">0  2023-01-05  0930  100</span><br><span class="line">1  2023-01-05  0935  200</span><br><span class="line">2  2023-01-05  0940  333</span><br></pre></td></tr></table></figure><p>最简单的做法是直接两列按字符串拼接：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;日期时间1&#x27;</span>] = df[<span class="string">&#x27;日期&#x27;</span>] + <span class="string">&#x27; &#x27;</span> + df[<span class="string">&#x27;时间&#x27;</span>]</span><br></pre></td></tr></table></figure><p>如果要合并的列不是字符串，则需显式转化一下再合并：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;日期时间2&#x27;</span>] = df[<span class="string">&#x27;日期&#x27;</span>].astype(<span class="built_in">str</span>) + <span class="string">&#x27; &#x27;</span> + df[<span class="string">&#x27;时间&#x27;</span>].astype(<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure><p>还可以这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;日期时间3&#x27;</span>] = df[[<span class="string">&#x27;日期&#x27;</span>,<span class="string">&#x27;时间&#x27;</span>]].apply(<span class="keyword">lambda</span> x: <span class="string">&#x27; &#x27;</span>.join(x), axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>或者：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;日期时间4&#x27;</span>] = df.apply(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;日期&#x27;</span>] + <span class="string">&#x27; &#x27;</span> + x[<span class="string">&#x27;时间&#x27;</span>], axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>如果要合并的列中有<code>nan</code>,则可以使用这个：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;日期时间5&#x27;</span>] = df[<span class="string">&#x27;日期&#x27;</span>].<span class="built_in">str</span>.cat(df[<span class="string">&#x27;时间&#x27;</span>], sep=<span class="string">&#x27; &#x27;</span>, na_rep=<span class="string">&#x27;?&#x27;</span>)</span><br></pre></td></tr></table></figure><p>最后效果如下:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; <span class="built_in">df</span></span></span><br><span class="line">       日期    时间   数量      日期时间1        日期时间2        日期时间3         日期时间4        日期时间5</span><br><span class="line">0  2023-01-05  0930  100  2023-01-05 0930  2023-01-05 0930  2023-01-05 0930  2023-01-05 0930  2023-01-05 0930</span><br><span class="line">1  2023-01-05  0935  200  2023-01-05 0935  2023-01-05 0935  2023-01-05 0935  2023-01-05 0935  2023-01-05 0935</span><br><span class="line">2  2023-01-05  0940  333  2023-01-05 0940  2023-01-05 0940  2023-01-05 0940  2023-01-05 0940  2023-01-05 0940</span><br></pre></td></tr></table></figure><p>完毕！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="http://example.com/2023/11/20/how-to-reduce-dataframe-columns-with-pandas/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ocre"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="憨憨呆呆的IT之旅"><meta itemprop="description" content="这是ocre的个人技术博客，主要记录日常接触的一些技术知识，涵盖后端开发、服务器运维、数据分析等IT领域。也会记录一些所遇问题的解决办法，以备自己和有需要的人按需查找。记录风格偏流水账一些，知识点较分散，尚未成体系，是为：憨憨呆呆的IT之旅。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 憨憨呆呆的IT之旅"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2023/11/20/how-to-reduce-dataframe-columns-with-pandas/" class="post-title-link" itemprop="url">pandas中如何合并DataFrame多行记录</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-20 12:15:32 / 修改时间：15:05:40" itemprop="dateCreated datePublished" datetime="2023-11-20T12:15:32+08:00">2023-11-20</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>247</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>如下DataFrame, 有三个列<code>site</code>、<code>material</code>、<code>LT</code>，现需要根据<code>material</code>把<code>site</code>去重后合并，并取出<code>LT</code>最大值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame([[<span class="string">&#x27;FJZ&#x27;</span>,<span class="string">&#x27;A123&#x27;</span>,<span class="number">123</span>],</span><br><span class="line">       [<span class="string">&#x27;FOC&#x27;</span>,<span class="string">&#x27;A123&#x27;</span>,<span class="number">456</span>],</span><br><span class="line">       [<span class="string">&#x27;FJZ&#x27;</span>,<span class="string">&#x27;B456&#x27;</span>,<span class="number">112</span>],</span><br><span class="line">       [<span class="string">&#x27;FJZ&#x27;</span>,<span class="string">&#x27;B456&#x27;</span>,<span class="number">245</span>],</span><br><span class="line">       [<span class="string">&#x27;FJZ&#x27;</span>,<span class="string">&#x27;B456&#x27;</span>,<span class="number">110</span>],</span><br><span class="line">       [<span class="string">&#x27;FOC&#x27;</span>,<span class="string">&#x27;C789&#x27;</span>,<span class="number">202</span>],</span><br><span class="line">       [<span class="string">&#x27;FOC&#x27;</span>,<span class="string">&#x27;C789&#x27;</span>,<span class="number">205</span>]],columns=[<span class="string">&#x27;site&#x27;</span>,<span class="string">&#x27;material&#x27;</span>,<span class="string">&#x27;LT&#x27;</span>])</span><br></pre></td></tr></table></figure><p>原始DataFrame数据如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  site material   LT</span><br><span class="line">0  FJZ     A123  123</span><br><span class="line">1  FOC     A123  456</span><br><span class="line">2  FJZ     B456  112</span><br><span class="line">3  FJZ     B456  245</span><br><span class="line">4  FJZ     B456  110</span><br><span class="line">5  FOC     C789  202</span><br><span class="line">6  FOC     C789  205</span><br></pre></td></tr></table></figure><p>直接<code>groupby</code>后<code>join</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.groupby(<span class="string">&#x27;material&#x27;</span>).agg(&#123;<span class="string">&#x27;site&#x27;</span>: <span class="string">&#x27;,&#x27;</span>.join, <span class="string">&#x27;LT&#x27;</span>: <span class="built_in">max</span>&#125;).reset_index()</span><br></pre></td></tr></table></figure><p>处理后数据如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  material         site   LT</span><br><span class="line">0     A123      FJZ,FOC  456</span><br><span class="line">1     B456  FJZ,FJZ,FJZ  245</span><br><span class="line">2     C789      FOC,FOC  205</span><br></pre></td></tr></table></figure><p>第二行数据中，<code>site</code>列的<code>FJZ</code>出现了重复。<br>这里我们换一种思路，由于<code>site</code>列涉及去重、拼接两个步骤，可以先定义一个处理函数，把这两个步骤串起来。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">agg_func</span>(<span class="params">items</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span>.join(<span class="built_in">set</span>(items))</span><br></pre></td></tr></table></figure><p>然后再调用这个函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.groupby(<span class="string">&#x27;material&#x27;</span>).agg(&#123;<span class="string">&#x27;site&#x27;</span>: agg_func, <span class="string">&#x27;LT&#x27;</span>: <span class="built_in">max</span>&#125;).reset_index()</span><br></pre></td></tr></table></figure><p>最后效果如下:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  material     site   LT</span><br><span class="line">0     A123  FJZ,FOC  456</span><br><span class="line">1     B456      FJZ  245</span><br><span class="line">2     C789      FOC  205</span><br></pre></td></tr></table></figure><p>完毕！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">ocre</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">40k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:24</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><a href="https://github.com/ocre" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous"><script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"ocre","repo":"ocre.github.io","client_id":"3a37366d19d251900ca8","client_secret":"0b20f0ec1acc51216234b394aa147ae6979c0ddf","admin_user":"ocre","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d1546d731a9f30cc80127d57142a482b"}</script><script src="/js/third-party/comments/gitalk.js"></script></body></html>